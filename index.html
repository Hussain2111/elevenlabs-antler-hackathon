<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antler Surgery - The NHS Voice AI GP Surgery in Aldgate East</title>
    <link rel="stylesheet" href="/src/styles/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Cookie Banner -->
    <div id="cookie-banner" class="cookie-banner">
        <div class="cookie-content">
            <h2>Tell us whether you accept cookies</h2>
            <p>We've put some small files called cookies on your device to make our site work. We would also like to use analytical cookies to understand how our site is used and improve user experience. Analytical cookies send information to Google Analytics.</p>
            <p>Let us know your preference. We will use a cookie to save your choice. Before you make your choice you can read more about our cookie policy.</p>
            <div class="cookie-buttons">
                <button class="btn btn-primary" onclick="acceptCookies()">I'm OK with cookies</button>
                <button class="btn btn-secondary" onclick="setCookiePreferences()">Set my cookie preferences</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="site-header">
        <div class="skip-link">
            <a href="#main-content">Skip to main content</a>
        </div>
        <div class="header-content">
            <div class="logo-section">
                <span class="nhs-logo">NHS</span>
                <div class="surgery-info">
                    <h1>Antler Surgery</h1>
                    <p>The NHS Voice AI GP Surgery in Aldgate East</p>
                </div>
            </div>
            <div class="search-section">
                <input type="search" placeholder="Search the Antler Surgery website" class="search-input">
                <button class="search-btn">Search</button>
            </div>
        </div>
        <nav class="main-nav">
            <ul>
                <li><a href="#appointments">Appointments</a></li>
                <li><a href="#prescriptions">Prescriptions</a></li>
                <li><a href="#services">Services</a></li>
                <li><a href="#about">About the surgery</a></li>
                <li><a href="#register">Register with the surgery</a></li>
                <li><a href="#contact">Contact us</a></li>
                <li><a href="#home">Home</a></li>
                <li><a href="#more">Browse More</a></li>
            </ul>
        </nav>
    </header>

    <!-- Translate Banner -->
    <div class="translate-banner">
        <button class="translate-btn">Translate this website</button>
    </div>

    <!-- NHS App Banner -->
    <div class="nhs-app-banner">
        <div class="banner-content">
            <strong>Do more with the NHS App!</strong>
            <a href="#">Get help with the NHS App</a>
        </div>
    </div>

    <!-- Main Content -->
    <main id="main-content">
        <div class="container">
            <h1 class="page-title">Antler Surgery</h1>
            
            <!-- Service Cards Grid -->
            <div class="service-grid">
                <div class="service-card">
                    <h2>Appointments</h2>
                    <p>Find out how to make, change or cancel an appointment</p>
                </div>
                <div class="service-card">
                    <h2>Prescriptions</h2>
                    <p>Get a repeat prescription, find a pharmacy or ask a prescription question</p>
                </div>
                <div class="service-card">
                    <h2>Sick notes</h2>
                    <p>Get a sick (fit) note for work or find out about self-certification</p>
                </div>
                <div class="service-card">
                    <h2>Test results</h2>
                    <p>Get your recent test results and find out what to do next</p>
                </div>
                <div class="service-card">
                    <h2>Register with us</h2>
                    <p>Find out how to register and if you live in our catchment area</p>
                </div>
                <div class="service-card">
                    <h2>Contact us</h2>
                    <p>Find out how to contact the surgery and what to do when we are closed</p>
                </div>
                <div class="service-card">
                    <h2>NHS App</h2>
                    <p>Access NHS Health Benefits and Services</p>
                </div>
                <div class="service-card">
                    <h2>Pharmacy First</h2>
                    <p>Self Refer For A Minor Illness</p>
                </div>
            </div>

            <!-- Local Services Section -->
            <section class="local-services">
                <h2>Local and NHS services</h2>
                <p>Find the service and help you need.</p>
                <div class="service-links">
                    <ul>
                        <li><a href="#">Find a pharmacy</a></li>
                        <li><a href="#">Find an urgent treatment centre</a></li>
                        <li><a href="#">Find an NHS dentist</a></li>
                        <li><a href="#">Find your NHS number</a></li>
                        <li><a href="#">Health A to Z</a></li>
                        <li><a href="#">Medicines A to Z</a></li>
                        <li><a href="#">Sport Activity Finder</a></li>
                    </ul>
                </div>
                <a href="#" class="btn-link">Find other patient services</a>
            </section>

            <!-- Latest News Section -->
            <section class="latest-news">
                <h2>Latest surgery news</h2>
                <div class="news-items">
                    <article class="news-item">
                        <h3>You and Your Practice</h3>
                        <time>26th August 2025</time>
                        <p>You and your general practice (YYGP) has been developed to help patients understand what to expect from their general practice…</p>
                    </article>
                    <article class="news-item">
                        <h3>Weight Loss Medication</h3>
                        <time>11th July 2025</time>
                        <p>The NHS is gradually making new weight loss medications (such as tirzepatide, also known as Mounjaro) available to a small…</p>
                    </article>
                    <article class="news-item">
                        <h3>Health Promotion and Immunisation</h3>
                        <time>11th July 2025</time>
                        <p>Immunisations Vaccines are the most effective way to prevent many infectious diseases• Child immunisationsOne of the best ways to protect…</p>
                    </article>
                </div>
                <a href="#" class="btn-link">Go to news</a>
            </section>

            <!-- Feedback Section -->
            <section class="feedback-section">
                <h2>NHS Friends and Family Test</h2>
                <p>We want you to have the best possible experience of care. Provide feedback and you can help us improve our services.</p>
                <a href="#" class="btn btn-primary">Take part in the NHS Friends and Family Test</a>
            </section>

            <!-- NHS App Promotion -->
            <section class="nhs-app-promotion">
                <h2>Get help with the NHS App</h2>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <div class="footer-content">
                <div class="contact-info">
                    <address>
                        32-38 Leman St<br>
                        London<br>
                        E1 8EW
                    </address>
                    <a href="#" class="directions-link">Get directions</a>
                    <p class="phone">+1 978 723 0004</p>
                </div>
                <div class="footer-links">
                    <div class="footer-column">
                        <ul>
                            <li><a href="#">Appointments</a></li>
                            <li><a href="#">Prescriptions</a></li>
                            <li><a href="#">Services</a></li>
                            <li><a href="#">About the surgery</a></li>
                            <li><a href="#">Register with the surgery</a></li>
                            <li><a href="#">Contact us</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <ul>
                            <li><a href="#">Opening times</a></li>
                            <li><a href="#">Sick (fit) notes</a></li>
                            <li><a href="#">Test results</a></li>
                            <li><a href="#">Feedback and complaints</a></li>
                            <li><a href="#">Wellbeing</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>Providing NHS services</p>
                <p>&copy;</p>
                <div class="footer-policies">
                    <a href="#">Accessibility statement</a>
                    <a href="#">Website policies</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Call Widget -->
    <div id="call-widget" class="call-widget">
        <div class="widget-body">
            <div class="widget-content">
                <div class="avatar-container">
                    <div class="avatar-circle" id="avatar-circle">
                        <svg class="avatar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                    </div>
                    <div class="pulse-ring"></div>
                </div>
                <div class="status-text" id="status-text">AI Assistant</div>
                <div class="call-timer" id="call-timer" style="display: none;">
                    <span id="timer">00:00</span>
                </div>
            </div>
            <div class="controls">
                <button id="call-button" class="call-button">
                    <svg class="phone-icon" id="phone-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 00-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/>
                    </svg>
                    <svg class="end-icon" id="end-icon" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                        <path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.57.9-.7.36-1.37.78-2 1.24-.33.25-.8.19-1.07-.13L1.21 12.28a.977.977 0 010-1.38l2.55-2.55c.27-.32.74-.38 1.07-.13.63.46 1.3.88 2 1.24.34.16.57.51.57.9v3.1c1.45-.48 3-.73 4.6-.73s3.15.25 4.6.72v-3.1c0-.39.23-.74.57-.9.7-.36 1.37-.78 2-1.24.33-.25.8-.19 1.07.13l2.55 2.55c.31.31.31.81 0 1.12l-2.55 2.55c-.27.32-.74.38-1.07.13-.63-.46-1.3-.88-2-1.24-.34-.16-.57-.51-.57-.9v-3.1A15.748 15.748 0 0012 9z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Widget Toggle Button -->
    <button id="widget-toggle" class="widget-toggle" onclick="toggleWidget()">
        <svg class="chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
        </svg>
    </button>

    <!-- Anam AI Widget -->
    <div id="anam-widget" class="anam-widget">
        <div class="widget-body">
            <div class="widget-content expanded-content" style="display: none;">
                <div class="anam-header">
                    <h3>Mental Health Support</h3>
                    <button class="close-btn" onclick="toggleAnamWidget()">×</button>
                </div>
                <iframe
                    src="https://lab.anam.ai/frame/HEGviGRgQ1W9dp5eJh2ad"
                    width="720"
                    height="480"
                    allow="microphone"
                    class="anam-iframe"
                ></iframe>
            </div>
        </div>
        <div class="tooltip">Mental Health Support</div>
    </div>

    <!-- Anam Widget Toggle Button -->
    <button id="anam-toggle" class="anam-toggle">
        <svg class="user-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
    </button>

    <!-- Scripts -->
    <script src="src/utils/audio.js"></script>
    <script src="src/utils/synthflow.js"></script>
    <script src="src/utils/deepgram.js"></script>
    <script src="src/components/CallWidget.js"></script>
    <script>
        // Load configuration from server
        async function loadConfig() {
            try {
                // Use the actual server URL
                const protocol = window.location.protocol;
                const host = window.location.host;
                const serverUrl = window.location.hostname === 'localhost' ? 'http://localhost:3000' : `${protocol}//${host}`;
                
                console.log('Detected server URL:', serverUrl);
                
                const response = await fetch(`${serverUrl}/api/config`);
                const config = await response.json();
                window.SYNTHFLOW_ASSISTANT_ID = config.synthflowAssistantId;
                window.SERVER_URL = serverUrl;
                localStorage.setItem('downstreamWebSocketUrl', config.downstreamWebSocketUrl);
            } catch (error) {
                console.error('Failed to load configuration:', error);
            }
        }

        // Cookie functions
        function acceptCookies() {
            document.getElementById('cookie-banner').style.display = 'none';
            localStorage.setItem('cookiesAccepted', 'true');
        }

        function setCookiePreferences() {
            alert('Cookie preferences panel would open here');
            document.getElementById('cookie-banner').style.display = 'none';
        }

        // Check if cookies already accepted
        if (localStorage.getItem('cookiesAccepted') === 'true') {
            document.getElementById('cookie-banner').style.display = 'none';
        }

        // Load config on page load
        loadConfig();

        // Anam Widget Functions
        let anamWidgetOpen = false;

        function toggleAnamWidget() {
            const widget = document.getElementById('anam-widget');
            const toggleBtn = document.getElementById('anam-toggle');
            const expandedContent = widget.querySelector('.expanded-content');
            
            if (anamWidgetOpen) {
                // Close widget
                widget.classList.remove('expanded');
                expandedContent.style.display = 'none';
                toggleBtn.style.display = 'flex';
                anamWidgetOpen = false;
            } else {
                // Open widget
                widget.classList.add('expanded');
                expandedContent.style.display = 'flex';
                toggleBtn.style.display = 'none';
                anamWidgetOpen = true;
            }
        }

        // Export to window for HTML onclick handlers
        window.toggleAnamWidget = toggleAnamWidget;

        // Drag functionality
        let dragData = {
            isDragging: false,
            hasDragged: false,
            currentElement: null,
            startX: 0,
            startY: 0,
            elementStartX: 0,
            elementStartY: 0,
            dragThreshold: 5 // pixels - minimum movement to start drag
        };

        function initializeDragListeners() {
            const anamToggle = document.getElementById('anam-toggle');
            const anamWidget = document.getElementById('anam-widget');
            const callWidget = document.getElementById('call-widget');
            const callButton = document.getElementById('call-button');

            // Add drag listeners to all draggable elements
            [anamToggle, anamWidget, callWidget, callButton].forEach(element => {
                if (element) {
                    element.addEventListener('mousedown', handleDragStart);
                    element.addEventListener('touchstart', handleDragStart, { passive: false });
                }
            });

            // Global listeners for drag move and end
            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', handleDragEnd);
            document.addEventListener('touchmove', handleDragMove, { passive: false });
            document.addEventListener('touchend', handleDragEnd);
        }

        function handleDragStart(e) {
            // Don't start drag if clicking on buttons inside widgets
            if (e.target.tagName === 'BUTTON' && e.target !== e.currentTarget) return;
            if (e.target.closest('iframe')) return;
            if (e.target.closest('.close-btn')) return;

            // Initialize drag data but don't start dragging yet
            dragData.currentElement = e.currentTarget;
            dragData.hasDragged = false;

            const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;

            dragData.startX = clientX;
            dragData.startY = clientY;

            const rect = dragData.currentElement.getBoundingClientRect();
            dragData.elementStartX = rect.left;
            dragData.elementStartY = rect.top;

            // Only prevent default for touch events to avoid issues
            if (e.type === 'touchstart') {
                e.preventDefault();
            }
        }

        function handleDragMove(e) {
            if (!dragData.currentElement) return;

            const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

            const deltaX = clientX - dragData.startX;
            const deltaY = clientY - dragData.startY;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

            // Only start dragging if we've moved beyond the threshold
            if (!dragData.isDragging && distance > dragData.dragThreshold) {
                dragData.isDragging = true;
                dragData.hasDragged = true;
                dragData.currentElement.classList.add('dragging');
                document.body.style.userSelect = 'none';
            }

            if (!dragData.isDragging) return;

            e.preventDefault();

            const newX = dragData.elementStartX + deltaX;
            const newY = dragData.elementStartY + deltaY;

            // Constrain to viewport
            const element = dragData.currentElement;
            const rect = element.getBoundingClientRect();
            const maxX = window.innerWidth - rect.width;
            const maxY = window.innerHeight - rect.height;

            const constrainedX = Math.max(0, Math.min(maxX, newX));
            const constrainedY = Math.max(0, Math.min(maxY, newY));

            // Update position using left/top instead of bottom/right
            element.style.left = constrainedX + 'px';
            element.style.top = constrainedY + 'px';
            element.style.right = 'auto';
            element.style.bottom = 'auto';
        }

        function handleDragEnd(e) {
            if (!dragData.currentElement) return;

            // Only save position and clean up if we actually dragged
            if (dragData.isDragging) {
                dragData.currentElement.classList.remove('dragging');
                
                // Save position to localStorage
                const element = dragData.currentElement;
                const rect = element.getBoundingClientRect();
                const position = {
                    left: rect.left,
                    top: rect.top
                };
                
                localStorage.setItem(element.id + '_position', JSON.stringify(position));
                document.body.style.userSelect = '';
            }

            // If we didn't drag (just clicked), allow the click event to proceed
            if (!dragData.hasDragged) {
                // For anam toggle, trigger the widget toggle
                if (dragData.currentElement.id === 'anam-toggle') {
                    setTimeout(() => toggleAnamWidget(), 0);
                }
                // For call widget or call button, trigger the call toggle
                else if (dragData.currentElement.id === 'call-widget' || dragData.currentElement.id === 'call-button') {
                    setTimeout(() => toggleCall(), 0);
                }
            }

            // Reset drag data
            dragData.isDragging = false;
            dragData.hasDragged = false;
            dragData.currentElement = null;
        }

        function loadSavedPositions() {
            const anamToggle = document.getElementById('anam-toggle');
            const anamWidget = document.getElementById('anam-widget');
            const callWidget = document.getElementById('call-widget');
            const callButton = document.getElementById('call-button');

            [anamToggle, anamWidget, callWidget, callButton].forEach(element => {
                if (element) {
                    const savedPosition = localStorage.getItem(element.id + '_position');
                    if (savedPosition) {
                        const position = JSON.parse(savedPosition);
                        element.style.left = position.left + 'px';
                        element.style.top = position.top + 'px';
                        element.style.right = 'auto';
                        element.style.bottom = 'auto';
                    }
                }
            });
        }

        // Initialize drag functionality when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeDragListeners();
            loadSavedPositions();
        });
    </script>
</body>
</html>
